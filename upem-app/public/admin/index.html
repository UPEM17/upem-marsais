<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin UPEM</title>
  <link rel="stylesheet" href="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.css" />
  <style>
    :root{color-scheme:light only}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:#f5f7fb;margin:0}
    .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 6px 24px rgba(10,20,40,.06);padding:24px;max-width:420px;width:100%}
    .row{margin:10px 0}
    input{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:10px;font-size:16px}
    button{width:100%;padding:12px;border:0;border-radius:10px;background:#111827;color:#fff;font-weight:700;cursor:pointer}
    .muted{color:#6b7280;font-size:13px;margin-top:10px}
    .hidden{display:none}
    .logo{display:block;margin:0 auto 14px auto;height:80px}
    .err{color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:10px;margin-top:10px}
  </style>

  <!-- On va initialiser Decap manuellement -->
  <script>window.CMS_MANUAL_INIT = true;</script>
</head>
<body>
  <div id="gate" class="wrap">
    <div class="card">
      <img src="/logo.png" alt="UPEM" class="logo" />
      <h2 style="text-align:center;margin:0 0 10px">Connexion Admin</h2>
      <div class="row">
        <input id="user" type="text" placeholder="Identifiant (ex. admin)" autocomplete="username" />
      </div>
      <div class="row">
        <input id="pwd" type="password" placeholder="Mot de passe" autocomplete="current-password" />
      </div>
      <div class="row">
        <button id="go">Se connecter</button>
      </div>
      <div id="err" class="err hidden"></div>
      <p class="muted" style="text-align:center">Accès réservé aux administrateurs UPEM.</p>
    </div>
  </div>

  <div id="cms" class="hidden"></div>

  <script>
    // ---------- Helpers ----------
    function $(id){ return document.getElementById(id); }
    function showCMS(){
      $('gate').classList.add('hidden');
      $('cms').classList.remove('hidden');
    }
    function parseHash() {
      const h = (location.hash || '').replace(/^#\/?/, '');
      const out = {};
      h.split('&').forEach(p=>{
        const [k,v] = p.split('=');
        if(k) out[decodeURIComponent(k)] = decodeURIComponent(v||'');
      });
      return out;
    }
    function saveTokenToLocalStorage(token) {
      // Objet attendu par Decap (garde aussi l'ancien nom pour compatibilité)
      const user = {
        token,
        backendName: 'github',
        login: 'admin',
        name: 'UPEM Admin',
      };
      try {
        localStorage.setItem('decap-cms-user', JSON.stringify(user));
        localStorage.setItem('netlify-cms-user', JSON.stringify(user)); // compat
      } catch(_) {}
    }
    function loadCMS() {
      // Charge le script puis lance CMS.init()
      if (window.CMS) { window.CMS.init(); return; }
      const s = document.createElement('script');
      s.src = 'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js';
      s.onload = function(){ window.CMS.init(); };
      document.body.appendChild(s);
    }
    function startCMSWithToken(token) {
      saveTokenToLocalStorage(token);
      // Nettoie l'URL (on retire le token du hash)
      history.replaceState(null, '', location.pathname);
      showCMS();
      loadCMS();
    }

    // ---------- Login via function ----------
    async function login(){
      const username = ($('user').value || '').trim();
      const password = ($('pwd').value || '').trim();
      const errBox = $('err');
      errBox.classList.add('hidden'); errBox.textContent = '';

      try{
        const res = await fetch('/api/admin/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok || !data.access_token) {
          throw new Error(data?.error || 'Échec de l’authentification');
        }
        startCMSWithToken(data.access_token);
      }catch(e){
        errBox.textContent = (e && e.message) ? e.message : 'Erreur';
        errBox.classList.remove('hidden');
      }
    }

    $('go').addEventListener('click', login);
    $('pwd').addEventListener('keydown', (e)=>{ if(e.key==='Enter') login(); });

    // ---------- Cas où on arrive avec un #access_token dans l'URL ----------
    (function bootstrap(){
      const q = parseHash();
      if (q.access_token) {
        startCMSWithToken(q.access_token);
      }
    })();
  </script>
</body>
</html>
