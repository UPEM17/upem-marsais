<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin UPEM</title>
  <link rel="stylesheet" href="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.css" />
  <style>
    :root { color-scheme: light; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:#f5f7fb;margin:0}
    .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 6px 24px rgba(10,20,40,.06);padding:24px;max-width:420px;width:100%}
    .row{margin:10px 0}
    input{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:10px;font-size:16px}
    button{width:100%;padding:12px;border:0;border-radius:10px;background:#111827;color:#fff;font-weight:700;cursor:pointer}
    .muted{color:#6b7280;font-size:13px;margin-top:10px}
    .hidden{display:none}
    .logo{display:block;margin:0 auto 14px auto;height:80px}
    .err{color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:10px;margin-top:10px;white-space:pre-wrap}
  </style>
  <script>
    // Decap sera initialisé "à la main"
    window.CMS_MANUAL_INIT = true;

    // Corrige l'ancien hash "#/access_token=…"
    (function () {
      const h = location.hash || "";
      if (h.startsWith("#/access_token=")) {
        history.replaceState(null, "", location.pathname + "#" + h.slice(2));
      }
    })();
  </script>
</head>
<body>
  <div id="gate" class="wrap">
    <div class="card">
      <img src="/logo.png" alt="UPEM" class="logo" />
      <h2 style="text-align:center;margin:0 0 10px">Connexion Admin</h2>
      <div class="row">
        <input id="user" type="text" placeholder="Identifiant (ex. admin)" autocomplete="username" />
      </div>
      <div class="row">
        <input id="pwd" type="password" placeholder="Mot de passe" autocomplete="current-password" />
      </div>
      <div class="row">
        <button id="go">Se connecter</button>
      </div>
      <div id="err" class="err hidden"></div>
      <p class="muted" style="text-align:center">Accès réservé aux administrateurs UPEM.</p>
    </div>
  </div>

  <!-- Conteneur CMS (caché jusqu'à init) -->
  <div id="cms" class="hidden"></div>

  <script>
    function hasToken(){ return (location.hash || "").includes("access_token="); }

    function showCMS(){
      document.getElementById('gate').classList.add('hidden');
      document.getElementById('cms').classList.remove('hidden');
    }

    function showError(msg){
      const errBox = document.getElementById('err');
      errBox.textContent = msg;
      errBox.classList.remove('hidden');
    }

    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s = document.createElement('script');
        s.src = src; s.async = true; s.onload = resolve; s.onerror = () => reject(new Error('Échec chargement script '+src));
        document.body.appendChild(s);
      });
    }

    async function initCMS(){
      try{
        showCMS();
        // Charge le bundle Decap si pas déjà présent
        if (!window.CMS) {
          await loadScript('https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js');
        }
        // Initialise avec notre config
        window.CMS.init({ config: '/admin/config.yml' });
      }catch(e){
        // Remet le gate et affiche l'erreur
        document.getElementById('cms').classList.add('hidden');
        document.getElementById('gate').classList.remove('hidden');
        showError(e?.message || 'Impossible d’initialiser le CMS.');
      }
    }

    async function login(){
      const username = (document.getElementById('user').value || "").trim();
      const password = (document.getElementById('pwd').value || "").trim();
      const errBox = document.getElementById('err');
      errBox.classList.add('hidden'); errBox.textContent = "";

      try{
        const res = await fetch('/api/admin/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        let data;
        try {
          data = await res.clone().json(); // tente JSON
        } catch {
          const txt = await res.text();    // sinon texte brut
          throw new Error(`${res.status} ${res.statusText} – ${txt || 'empty body'}`);
        }

        if (!res.ok || !data?.access_token) {
          throw new Error(data?.error || `${res.status} ${res.statusText}`);
        }

        // Injecte le token pour le backend GitHub de Decap
        const hash = `#access_token=${encodeURIComponent(data.access_token)}&token_type=${encodeURIComponent(data.token_type||'bearer')}&provider=${encodeURIComponent(data.provider||'github')}`;
        history.replaceState(null, "", location.pathname + hash);

        // Lance le CMS
        await initCMS();
      }catch(e){
        showError(e.message || 'Erreur');
      }
    }

    document.getElementById('go').addEventListener('click', login);
    document.getElementById('pwd').addEventListener('keydown', (e)=>{ if(e.key==='Enter') login(); });

    // Si déjà un token dans l’URL, on init directement le CMS
    if (hasToken()) { initCMS(); }
  </script>
</body>
</html>
