<script>
  // Fix ancien hash "#/access_token=…"
  (function () {
    const h = location.hash || "";
    if (h.startsWith("#/access_token=")) {
      history.replaceState(null, "", location.pathname + "#" + h.slice(2));
    }
  })();

  function hasToken(){ return (location.hash || "").includes("access_token="); }
  function showCMS(){
    document.getElementById('gate').classList.add('hidden');
    document.getElementById('cms').classList.remove('hidden');
  }

  async function login(){
    const username = (document.getElementById('user').value || "").trim();
    const password = (document.getElementById('pwd').value || "").trim();
    const errBox = document.getElementById('err');
    errBox.classList.add('hidden'); errBox.textContent = "";

    try{
      const res = await fetch('/api/admin/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      let data;
      try {
        data = await res.clone().json(); // tente JSON
      } catch {
        const txt = await res.text();    // sinon texte brut
        throw new Error(`${res.status} ${res.statusText} – ${txt || 'empty body'}`);
      }

      if (!res.ok || !data?.access_token) {
        throw new Error(data?.error || `${res.status} ${res.statusText}`);
      }

      const hash = `#access_token=${encodeURIComponent(data.access_token)}&token_type=${encodeURIComponent(data.token_type||'bearer')}&provider=${encodeURIComponent(data.provider||'github')}`;
      history.replaceState(null, "", location.pathname + hash);
      showCMS();
    }catch(e){
      errBox.textContent = e.message || 'Erreur';
      errBox.classList.remove('hidden');
    }
  }

  document.getElementById('go').addEventListener('click', login);
  document.getElementById('pwd').addEventListener('keydown', (e)=>{ if(e.key==='Enter') login(); });

  if (hasToken()) { showCMS(); }
</script>
